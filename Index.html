import React, { useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Clock, ChevronUp, ChevronDown, Trash2 } from "lucide-react";

const HabitTracker = () => {
  const today = new Date().toDateString();
  const [habits, setHabits] = useState(() => {
    const saved = localStorage.getItem("habits");
    if (saved) {
      const parsed = JSON.parse(saved);
      if (parsed.date === today) {
        return parsed.habits;
      }
    }
    return Array.from({ length: 5 }, (_, i) => ({
      name: `Habit ${i + 1}`,
      completed: false,
      scheduledTime: { hours: 0, minutes: 0 }
    }));
  });

  useEffect(() => {
    localStorage.setItem("habits", JSON.stringify({ date: today, habits }));
  }, [habits, today]);

  const toggleHabit = (index) => {
    setHabits(prev => prev.map((habit, i) => 
      i === index ? { ...habit, completed: !habit.completed } : habit
    ));
  };

  const updateTime = (index, timeUnit, amount) => {
    setHabits(prev => prev.map((habit, i) => {
      if (i !== index) return habit;
      
      const newTime = { ...habit.scheduledTime };
      newTime[timeUnit] = Math.max(0, newTime[timeUnit] + amount);
      
      if (timeUnit === "minutes" && newTime.minutes > 59) {
        newTime.hours += Math.floor(newTime.minutes / 60);
        newTime.minutes = newTime.minutes % 60;
      }
      
      return { ...habit, scheduledTime: newTime };
    }));
  };

  const deleteHabit = (index) => {
    setHabits(prev => prev.filter((_, i) => i !== index));
  };

  const addHabit = () => {
    setHabits(prev => [
      ...prev,
      {
        name: `Habit ${prev.length + 1}`,
        completed: false,
        scheduledTime: { hours: 0, minutes: 0 }
      }
    ]);
  };

  const resetHabits = () => {
    setHabits(prev => prev.map(habit => ({
      ...habit,
      completed: false,
      scheduledTime: { hours: 0, minutes: 0 }
    })));
  };

  const formatTime = (time) => {
    const hrs = time.hours.toString().padStart(2, '0');
    const mins = time.minutes.toString().padStart(2, '0');
    return `${hrs}:${mins}`;
  };

  return (
    <div className="min-h-screen p-4 bg-gradient-to-br from-gray-900 to-gray-800 text-white">
      <div className="max-w-md mx-auto">
        <h1 className="text-3xl font-bold mb-6 text-center text-purple-300">
          Habit Tracker
        </h1>
        
        <Button 
          className="w-full mb-4 bg-purple-600 hover:bg-purple-700"
          onClick={addHabit}
        >
          Add New Habit
        </Button>
        
        <div className="grid grid-cols-1 gap-4">
          {habits.map((habit, index) => (
            <Card 
              key={index}
              className={`transition-all duration-200 border-gray-700 
                ${habit.completed 
                  ? "bg-gray-800 border-purple-400" 
                  : "bg-gray-900 hover:bg-gray-800"}`}
            >
              <CardContent className="p-4">
                <div className="flex justify-between items-start">
                  <div 
                    className="flex-1 cursor-pointer"
                    onClick={() => toggleHabit(index)}
                  >
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-lg font-medium">{habit.name}</span>
                      <input 
                        type="checkbox" 
                        checked={habit.completed} 
                        readOnly 
                        className="h-5 w-5 text-purple-400 border-gray-600 rounded focus:ring-purple-300"
                      />
                    </div>
                    
                    <div className="flex items-center justify-between mt-3">
                      <div className="flex items-center space-x-2">
                        <Clock className="text-purple-300" size={18} />
                        <span className="text-sm font-mono text-gray-300">
                          {formatTime(habit.scheduledTime)}
                        </span>
                      </div>
                      
                      <div className="flex space-x-4">
                        <div className="flex flex-col items-center">
                          <button
                            className="text-purple-300 hover:text-purple-200 p-1"
                            onClick={(e) => {
                              e.stopPropagation();
                              updateTime(index, "hours", 1);
                            }}
                          >
                            <ChevronUp size={16} />
                          </button>
                          <span className="text-xs text-gray-400">Hrs</span>
                          <button
                            className="text-purple-300 hover:text-purple-200 p-1"
                            onClick={(e) => {
                              e.stopPropagation();
                              updateTime(index, "hours", -1);
                            }}
                          >
                            <ChevronDown size={16} />
                          </button>
                        </div>
                        
                        <div className="flex flex-col items-center">
                          <button
                            className="text-purple-300 hover:text-purple-200 p-1"
                            onClick={(e) => {
                              e.stopPropagation();
                              updateTime(index, "minutes", 5);
                            }}
                          >
                            <ChevronUp size={16} />
                          </button>
                          <span className="text-xs text-gray-400">Mins</span>
                          <button
                            className="text-purple-300 hover:text-purple-200 p-1"
                            onClick={(e) => {
                              e.stopPropagation();
                              updateTime(index, "minutes", -5);
                            }}
                          >
                            <ChevronDown size={16} />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <button
                    className="ml-4 p-2 text-red-500 hover:text-red-400 transition-colors"
                    onClick={(e) => {
                      e.stopPropagation();
                      deleteHabit(index);
                    }}
                    aria-label="Delete habit"
                  >
                    <Trash2 size={18} className="hover:scale-110 transition-transform" />
                  </button>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
        
        <Button
          className="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold"
          onClick={resetHabits}
        >
          Reset for Next Day
        </Button>
      </div>
    </div>
  );
};

export default HabitTracker;
